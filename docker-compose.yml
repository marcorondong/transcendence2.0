services:
  pong-api:
    image: pong-api-img
    container_name: pong-api
    build:
      context: ./ssg/pong-api
      dockerfile: Dockerfile
    volumes:
      - ./ssg/pong-api/src/:/pong/pong-api/src/
    ports:
      - 3010:3010 #TODO remove it will not be exposed at final version
    environment:
      - NODE_ENV=production
    command: ["npm", "--prefix", "/pong/pong-api/", "run", "dev"]
    networks:
      - Transcendence2.0

  pong_db:
    image: pong_db_image
    container_name: pong_db_container
    build: ./microservices/pong_db
    environment:
      # - pass env variables from .env file
      - DATABASE_URL=file:/pong_db/DB/pongDB.db
      - NODE_ENV=development
      - PORT=3011
      - HOST=0.0.0.0
    volumes:
      - ./microservices/pong_db/src/:/pong_db/src/ #TODO remove in production
      - ./microservices/pong_db/prisma/:/pong_db/prisma/ #TODO remove in production
      # - /home/iguliyev/DBs/pong/:/pong_db/DB/ #TODO adjust local path and uncomment in production
    ports:
      - 3011:3011 #TODO remove it in production
    networks:
      - Transcendence2.0
    restart: always

  ai-bot:
    build:
      context: ./ssg
      dockerfile: ./AI/Dockerfile
    container_name: ai-bot
    environment:
      - NODE_ENV=production
    ports:
      - 6969:6969 #TODO keep now for swagger documentation, remove later
    networks:
      - Transcendence2.0

  frontend:
    build:
      context: ./frontend
      dockerfile: docker/nginx/Dockerfile-Nginx
    container_name: frontend
    # image: nginx:1.26.2
    volumes:
      - ./frontend/volume:/usr/share/nginx/html
      - ./frontend/docker/nginx/config/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "8080:443"
    restart: unless-stopped
    networks:
      - Transcendence2.0

  tictactoe_api:
    image: tictactoe_api_img 
    container_name: tictactoe_api_container
    build: ./tictactoe_api
    volumes:
      - ./tictactoe_api/src/:/tictactoe_api/src/ # TODO remove this in production
      - ./tictactoe_api/public/:/tictactoe_api/public/ # TODO remove this when there is real frontend
    environment:
      - NODE_ENV=production
      - PORT=3001
      - HOST=0.0.0.0
    ports:
      - 3001:3001 # TODO remove this in production
    depends_on:
      - tictactoe_db
    networks:
      - Transcendence2.0
    restart: always

  tictactoe_db:
    image: tictactoe_db_img 
    container_name: tictactoe_db_container
    build: ./tictactoe_db
    environment:
      - DATABASE_URL=file:/tictactoe_db/DB/tictactoeDB.db
      - NODE_ENV=development
      - PORT=3003
      - HOST=0.0.0.0
    volumes:
      - ./tictactoe_db/src/:/tictactoe_db/src/ # TODO remove this in production
      - ./tictactoe_db/prisma/:/tictactoe_db/prisma/ # TODO remove this in production
      # - /home/iguliyev/DBs/tictactoe/:/tictactoe_api/DB/ # TODO define path to db and uncomment this line when using the local DB
    ports:
      - 3003:3003 # TODO remove this in production
    networks:
      - Transcendence2.0
    restart: always

  chat_api:
    image: chat_api_img
    container_name: chat_api_container
    build:
      context: ./chat_api
      dockerfile: Dockerfile
    volumes:
      - ./chat_api/src:/chat_api/src
    environment:
      - NODE_ENV=production
      - PORT=3002
      - HOST=0.0.0.0
    ports:
      - "3002:3002"
    networks:
      - Transcendence2.0
    depends_on:
      - chat_db
    restart: always

  chat_db:
    image: chat_db_image
    container_name: chat_db_container
    build:
      context: ./chat_db
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=file:/chat_db/DB/chatDB.db
      - NODE_ENV=development
      - PORT=3004
      - HOST=0.0.0.0
    volumes:
      - ./chat_db/src/:/chat_db/src/
      - ./chat_db/prisma/:/chat_db/prisma/
      # - /home/iguliyev/DBs/chat/:/chat_db/DB/ # TODO uncomment this line when using the local DB
    ports:
      - 3004:3004
    networks:
      - Transcendence2.0
    restart: always

include:
  - ./monitoring/monitoring-docker-compose.yml
  - ./frontend/docker-compose.yml

networks:
  Transcendence2.0:
